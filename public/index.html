<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leaderboard ‚Äì OV Fitness Freaks League</title>

  <!-- Prevent caching/back usage after logout -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      position: relative;
      min-height: 100vh;
    }
    
    body::before {
      content: '';
      position: fixed;
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(139, 92, 246, 0.2) 0%, transparent 70%);
      top: -250px;
      right: -250px;
      border-radius: 50%;
      animation: float 8s ease-in-out infinite;
      z-index: 0;
    }
    
    body::after {
      content: '';
      position: fixed;
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(236, 72, 153, 0.15) 0%, transparent 70%);
      bottom: -200px;
      left: -200px;
      border-radius: 50%;
      animation: float 10s ease-in-out infinite reverse;
      z-index: 0;
    }
    
    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(30px, 30px); }
    }
    
    .glass-header {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .nav-link {
      position: relative;
      transition: all 0.3s ease;
    }
    
    .nav-link::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 0;
      height: 2px;
      background: linear-gradient(90deg, #8b5cf6, #ec4899);
      transition: width 0.3s ease;
    }
    
    .nav-link:hover::after {
      width: 100%;
    }
    
    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: 700;
      font-size: 0.9rem;
    }
    
    .rank-1 {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #1a1a2e;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
    }
    
    .rank-2 {
      background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
      color: #1a1a2e;
      box-shadow: 0 0 15px rgba(192, 192, 192, 0.3);
    }
    
    .rank-3 {
      background: linear-gradient(135deg, #cd7f32 0%, #e8a87c 100%);
      color: #1a1a2e;
      box-shadow: 0 0 15px rgba(205, 127, 50, 0.3);
    }
    
    .table-row {
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }
    
    .table-row:hover {
      background: rgba(139, 92, 246, 0.1);
      transform: scale(1.01);
    }
    
    .trophy-icon {
      display: inline-block;
      animation: bounce 2s ease-in-out infinite;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .points-badge {
      background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.85rem;
      display: inline-block;
    }
  </style>
</head>
<body class="m-0">

<header class="glass-header py-4 px-6 md:py-3 md:px-4 flex flex-wrap justify-between items-center relative z-10 sticky top-0">
  <div class="flex items-center gap-3">
    <img src="images/logo.png" class="w-12 h-12 md:w-auto md:h-[50px] object-contain rounded-lg" alt="League logo">
    <span class="text-xl md:text-lg font-bold leading-none bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
      OV Fitness Freaks League
    </span>
  </div>

  <nav class="flex flex-wrap gap-5 md:gap-3">
    <a href="index.html" class="nav-link no-underline text-white text-sm font-medium hover:text-purple-300">Leaderboard</a>
    <a href="upload.html" class="nav-link no-underline text-white text-sm font-medium hover:text-purple-300">Daily Upload</a>
    <a href="quest.html" class="nav-link no-underline text-white text-sm font-medium hover:text-purple-300">Weekly Quest</a>
    <a href="profile.html" class="nav-link no-underline text-white text-sm font-medium hover:text-purple-300">Profile</a>
    <a href="admin.html" class="nav-link no-underline text-white text-sm font-medium hover:text-purple-300">Admin</a>
    <a href="/api/logout" class="nav-link no-underline text-red-300 text-sm font-medium hover:text-red-200">Logout</a>
  </nav>
</header>

<main class="p-6 md:p-4 max-w-[1100px] mx-auto relative z-10">
  <div class="text-center mb-8">
    <div class="text-6xl mb-4 trophy-icon">üèÜ</div>
    <h1 class="m-0 mb-2 text-4xl md:text-3xl font-bold bg-gradient-to-r from-purple-400 via-pink-400 to-purple-400 bg-clip-text text-transparent">
      Leaderboard
    </h1>
    <p class="m-0 text-gray-300 text-base md:text-sm">
      Champions ranked by total points earned üí™
    </p>
  </div>

  <div class="glass-card rounded-2xl p-6 md:p-4 w-full overflow-x-auto">
    <table class="w-full border-collapse min-w-[320px]">
      <thead>
        <tr class="border-b border-white/10">
          <th class="p-4 md:p-3 text-left text-sm font-bold text-purple-300">Rank</th>
          <th class="p-4 md:p-3 text-left text-sm font-bold text-purple-300">Champion</th>
          <th class="p-4 md:p-3 text-left text-sm font-bold text-purple-300">Points</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
  </div>
</main>

<script>
  // If page is restored from bfcache (Back button), force a reload
  window.addEventListener('pageshow', function (event) {
    if (event.persisted) {
      window.location.reload();
    }
  });

  // Check login
  async function checkLogin() {
    const res = await fetch('/api/me');
    const data = await res.json();
    if (!data.user) {
      window.location.replace('login.html');
      return false;
    }
    return true;
  }

  // Load leaderboard
  async function loadLeaderboard() {
    const ok = await checkLogin();
    if (!ok) return;

    const tbody = document.getElementById('leaderboard-body');

    try {
      const res = await fetch('/api/leaderboard');
      if (!res.ok) {
        tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">Error loading leaderboard.</td></tr>';
        return;
      }

      let data = await res.json();

      // Just in case backend doesn't sort: sort by points desc, then username asc
      data.sort((a, b) => {
        if (b.totalPoints !== a.totalPoints) {
          return b.totalPoints - a.totalPoints;
        }
        return a.username.localeCompare(b.username);
      });

      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">No champions yet. Be the first! üöÄ</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      data.forEach((user, index) => {
        const rank = index + 1;
        const tr = document.createElement('tr');
        tr.className = 'table-row';
        
        let rankDisplay = '';
        if (rank === 1) {
          rankDisplay = `<span class="rank-badge rank-1">ü•á</span>`;
        } else if (rank === 2) {
          rankDisplay = `<span class="rank-badge rank-2">ü•à</span>`;
        } else if (rank === 3) {
          rankDisplay = `<span class="rank-badge rank-3">ü•â</span>`;
        } else {
          rankDisplay = `<span class="text-gray-400 font-semibold">#${rank}</span>`;
        }
        
        tr.innerHTML = `
          <td class="p-4 md:p-3 text-sm">${rankDisplay}</td>
          <td class="p-4 md:p-3 text-sm">
            <a href="profile.html?userId=${user.id}" class="text-purple-300 no-underline hover:text-purple-200 font-medium transition-colors">
              ${user.username}
            </a>
          </td>
          <td class="p-4 md:p-3 text-sm">
            <span class="points-badge">${user.totalPoints} pts</span>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error(err);
      tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">Error loading leaderboard.</td></tr>';
    }
  }

  loadLeaderboard();
</script>

</body>
</html>